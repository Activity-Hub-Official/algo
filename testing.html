<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ActivityHub ‚Äî Club Recommendations (Mock v3)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: {
            soft: "0 10px 30px rgba(2,6,23,.06)",
            card: "0 12px 34px rgba(2,6,23,.08)"
          }
        }
      }
    };
  </script>
  <style>
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .line-clamp-3{
      display:-webkit-box;
      -webkit-line-clamp:3;
      -webkit-box-orient:vertical;
      overflow:hidden;
    }
  </style>
</head>

<body class="min-h-screen bg-slate-50 text-slate-900">
  <header class="sticky top-0 z-50 border-b border-slate-200 bg-white/80 backdrop-blur">
    <div class="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-blue-600 text-white grid place-items-center shadow-soft">
          <span class="font-semibold">AH</span>
        </div>
        <div>
          <div class="font-semibold leading-tight">Club Recommendations</div>
          <div class="text-xs text-slate-500">Prototype: onboarding ‚Üí ranked matches ‚Üí ‚Äúwhy this‚Äù reasons</div>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnReload" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm hover:bg-slate-50">
          Reload data
        </button>
        <button id="btnWhat" class="rounded-xl bg-slate-900 px-3 py-2 text-sm text-white hover:bg-slate-800 shadow-soft">
          What is this?
        </button>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-6xl px-4 py-6">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      <section class="lg:col-span-4">
        <div class="rounded-3xl border border-slate-200 bg-white shadow-soft overflow-hidden">
          <div class="p-5 border-b border-slate-200 bg-slate-50">
            <div class="text-xs text-slate-500">Step 4 of 4</div>
            <div class="mt-1 text-xl font-semibold">Interests</div>
            <div class="mt-1 text-sm text-slate-600">Pick at least one interest. Then press <span class="font-medium">Get recommendations</span>.</div>
          </div>

          <div class="p-5 space-y-6">
            <div>
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold">Pick at least one interest</div>
                <button id="btnClearInterests" class="text-sm text-blue-600 hover:underline">Clear</button>
              </div>

              <div id="interestPills" class="mt-3 grid grid-cols-2 gap-3"></div>

              <div id="refineWrap" class="hidden mt-4 rounded-2xl border border-slate-200 bg-slate-50 p-4">
                <div class="text-sm font-semibold">Quick clarification</div>
                <div class="mt-1 text-sm text-slate-600">
                  You selected Faith and/or Cultural & Identity. Choose communities so we don‚Äôt recommend mismatched groups.
                </div>

                <div id="refineLoading" class="mt-3 text-sm text-slate-600">Loading options from the API‚Ä¶</div>

                <div id="refineBody" class="hidden mt-3 space-y-4">
                  <div id="faithBox" class="hidden">
                    <div class="flex items-center justify-between gap-3">
                      <div>
                        <div class="text-sm font-medium">Faith communities</div>
                        <div class="text-xs text-slate-500">Choose any that apply (or select ‚ÄúOpen‚Äù).</div>
                      </div>
                      <label class="inline-flex items-center gap-2 text-sm">
                        <input id="faithOpen" type="checkbox" class="h-4 w-4 rounded border-slate-300">
                        <span class="text-slate-700">Open</span>
                      </label>
                    </div>
                    <div id="faithTags" class="mt-2 flex flex-wrap gap-2"></div>
                  </div>

                  <div id="identityBox" class="hidden">
                    <div class="flex items-center justify-between gap-3">
                      <div>
                        <div class="text-sm font-medium">Cultural / identity communities</div>
                        <div class="text-xs text-slate-500">Choose any that apply (or select ‚ÄúOpen‚Äù).</div>
                      </div>
                      <label class="inline-flex items-center gap-2 text-sm">
                        <input id="identityOpen" type="checkbox" class="h-4 w-4 rounded border-slate-300">
                        <span class="text-slate-700">Open</span>
                      </label>
                    </div>
                    <div id="identityTags" class="mt-2 flex flex-wrap gap-2"></div>
                  </div>

                  <div class="text-xs text-slate-500">
                    Note: Professional/Academic results won‚Äôt include identity-affiliated professional orgs unless you explicitly choose communities here.
                  </div>
                </div>
              </div>
            </div>

              <div id="academicRefineWrap" class="hidden mt-4 rounded-2xl border border-slate-200 bg-slate-50 p-4">
                <div class="text-sm font-semibold">Refine Academic</div>
                <div class="mt-1 text-sm text-slate-600">
                  You selected Academic. Optionally choose disciplines to focus recommendations (this is a soft boost).
                </div>

                <div id="academicRefineLoading" class="mt-3 text-sm text-slate-600">Loading disciplines from the API‚Ä¶</div>

                <div id="academicRefineBody" class="hidden mt-3 space-y-3">
                  <div class="flex items-center justify-between gap-3">
                    <div>
                      <div class="text-sm font-medium">Disciplines</div>
                      <div class="text-xs text-slate-500">Choose any that apply (or select "Open").</div>
                    </div>
                    <label class="inline-flex items-center gap-2 text-sm">
                      <input id="disciplineOpen" type="checkbox" class="h-4 w-4 rounded border-slate-300">
                      <span class="text-slate-700">Open</span>
                    </label>
                  </div>
                  <div id="disciplineTags" class="mt-2 flex flex-wrap gap-2"></div>
                  <div class="text-xs text-slate-500">Tip: uncheck Open, then pick 1‚Äì3 disciplines to tighten Academic results without hiding everything.</div>
                </div>
              </div>

            <div class="grid grid-cols-2 gap-4">
              <div>
                <div class="text-sm font-semibold">College year</div>
                <select id="yearSelect" class="mt-2 w-full rounded-2xl border border-slate-200 px-3 py-2.5 text-sm bg-white focus:outline-none focus:ring-4 focus:ring-blue-100">
                  <option value="">Select‚Ä¶</option>
                  <option>Freshman</option>
                  <option>Sophomore</option>
                  <option>Junior</option>
                  <option>Senior</option>
                  <option>Graduate</option>
                </select>
                <div class="mt-2 text-xs text-slate-500">Used for ‚Äústage fit‚Äù (explore vs leadership/career).</div>
              </div>
              <div>
                <div class="text-sm font-semibold">Major</div>
                <input id="majorInput" class="mt-2 w-full rounded-2xl border border-slate-200 px-3 py-2.5 text-sm focus:outline-none focus:ring-4 focus:ring-blue-100" placeholder="e.g., Accounting" />
                <div class="mt-2 text-xs text-slate-500">Used as a soft boost (won‚Äôt override interests).</div>
              </div>
            </div>

            <div id="majorSuggestWrap" class="hidden rounded-2xl border border-slate-200 overflow-hidden">
              <div class="max-h-40 overflow-auto no-scrollbar divide-y divide-slate-100" id="majorSuggest"></div>
            </div>

            <div class="rounded-2xl border border-slate-200 p-4">
              <div class="text-sm font-semibold">Recommendation controls</div>
              <div class="text-xs text-slate-500">Tune the ‚Äúvibe‚Äù without changing your interests.</div>

              <div class="mt-3 space-y-3">
                <label class="flex items-start justify-between gap-3">
                  <div>
                    <div class="text-sm font-medium">Prefer active orgs</div>
                    <div class="text-xs text-slate-500">Light boost using activity signals.</div>
                  </div>
                  <input id="preferActive" type="checkbox" class="mt-1 h-4 w-4 rounded border-slate-300" checked>
                </label>

                <label class="flex items-start justify-between gap-3">
                  <div>
                    <div class="text-sm font-medium">Show ‚ÄúWhy this?‚Äù</div>
                    <div class="text-xs text-slate-500">Adds 1‚Äì3 short reasons per recommendation.</div>
                  </div>
                  <input id="showWhy" type="checkbox" class="mt-1 h-4 w-4 rounded border-slate-300" checked>
                </label>

                <label class="flex items-start justify-between gap-3">
                  <div>
                    <div class="text-sm font-medium">Debug breakdown</div>
                    <div class="text-xs text-slate-500">Show scoring components (for testing).</div>
                  </div>
                  <input id="debug" type="checkbox" class="mt-1 h-4 w-4 rounded border-slate-300">
                </label>

                <label class="flex items-start justify-between gap-3">
                  <div>
                    <div class="text-sm font-medium">Explain my picks</div>
                    <div class="text-xs text-slate-500">Show a conversational explanation for why each club was picked and how the Top 5 was stacked.</div>
                  </div>
                  <input id="showReasoning" type="checkbox" class="mt-1 h-4 w-4 rounded border-slate-300" checked>
                </label>
              </div>
            </div>

            <div class="flex items-center gap-3">
              <button id="btnGet" class="flex-1 rounded-2xl bg-blue-600 px-4 py-3 text-sm font-medium text-white hover:bg-blue-700 shadow-soft">
                Get recommendations
              </button>
              <button id="btnSurprise" class="rounded-2xl border border-slate-200 bg-white px-4 py-3 text-sm hover:bg-slate-50">
                Surprise me
              </button>
            </div>

            <div class="flex flex-wrap gap-2 pt-2">
              <span class="rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs text-slate-600">Account</span>
              <span class="rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs text-slate-600">School</span>
              <span class="rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs text-slate-600">Academics</span>
              <span class="rounded-full bg-blue-600 px-3 py-1.5 text-xs text-white">Interests</span>
            </div>
          </div>
        </div>
      </section>

      <section class="lg:col-span-8">
        <div class="rounded-3xl border border-slate-200 bg-white shadow-soft overflow-hidden">
          <div class="p-5 border-b border-slate-200 bg-white">
            <div class="flex items-start justify-between gap-4">
              <div>
                <div class="text-sm text-slate-500">Your results</div>
                <div class="text-2xl font-semibold">Recommended clubs</div>
              </div>
              <div class="flex items-center gap-3">
                <input id="search" class="w-52 sm:w-64 rounded-2xl border border-slate-200 px-3 py-2 text-sm focus:outline-none focus:ring-4 focus:ring-blue-100" placeholder="Search results..." />
                <select id="sort" class="rounded-2xl border border-slate-200 px-3 py-2 text-sm bg-white focus:outline-none focus:ring-4 focus:ring-blue-100">
                  <option value="best">Sort: Best match</option>
                  <option value="activity">Sort: Most active</option>
                  <option value="major">Sort: Major relevance</option>
                  <option value="az">Sort: A ‚Üí Z</option>
                </select>
              </div>
            </div>

            <div class="mt-4 flex items-center justify-between gap-3">
              <div class="flex flex-wrap items-center gap-2">
                <span id="matchCount" class="rounded-full bg-blue-50 px-3 py-1.5 text-xs text-blue-700 border border-blue-100">0 matches</span>
                <span id="profilePill" class="rounded-full bg-slate-50 px-3 py-1.5 text-xs text-slate-700 border border-slate-200">‚Äî</span>
              </div>
              <button id="btnResetResults" class="text-sm text-blue-600 hover:underline">Reset</button>
            </div>
          </div>
              <div id="coverageBanner" class="hidden mt-3 rounded-2xl border border-amber-200 bg-amber-50 px-4 py-3 text-sm text-amber-900">
                <div class="font-semibold">Missing something?</div>
                <div id="coverageBannerText" class="mt-1 text-amber-800"></div>
              </div>
              <div id="reasoningPanel" class="mt-3 rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-700">
                <div class="flex items-center justify-between gap-3">
                  <div class="font-semibold">Why these picks?</div>
                  <button id="btnCopyReasoning" class="rounded-xl border border-slate-200 bg-white px-3 py-1.5 text-xs hover:bg-slate-50">Copy</button>
                </div>
                <div id="reasoningText" class="mt-2 space-y-2"></div>
              </div>



          <div class="p-5">
            <div>
              <div>
                <div class="text-sm font-semibold">Recommended</div>
                <div class="text-xs text-slate-500">Top picks for you (includes at least one major-related org when available)</div>
              </div>
              <div id="recommended" class="mt-3 space-y-4"></div>
            </div>

            <div id="emptyState" class="hidden mt-5 rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-700">
              No matches found with the current filters. Try:
              <ul class="mt-2 list-disc ml-5 text-slate-600">
                <li>Adding more interests</li>
                <li>Turning on ‚ÄúOpen‚Äù for Faith/Identity</li>
                <li>Turning on ‚ÄúOpen‚Äù for Discipline (Academic)</li>
                <li>Clearing search</li>
              </ul>
            </div>
          </div>
        </div>

      <section class="lg:col-span-12">
        <div id="diagPanel" class="rounded-3xl border border-slate-200 bg-white shadow-soft overflow-hidden">
          <div class="p-5 border-b border-slate-200 bg-white flex items-start justify-between gap-4">
            <div>
              <div class="text-sm text-slate-500">Diagnostics</div>
              <div class="text-xl font-semibold">Inputs ‚Üí outputs (JSON)</div>
              <div class="mt-1 text-sm text-slate-600">Use this to quickly verify what the user selected and what the algorithm produced, including explanations.</div>
            </div>
            <div class="shrink-0 flex items-center gap-2">
              <button id="btnCopyDiag" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs hover:bg-slate-50">Copy JSON</button>
              <button id="btnDownloadDiagTxt" class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs hover:bg-slate-50">Download .txt</button>
            </div>
          </div>
          <div class="p-5">
            <pre id="diagJson" class="max-h-72 overflow-auto rounded-2xl border border-slate-200 bg-slate-50 p-4 text-xs leading-relaxed text-slate-800"></pre>
          </div>
        </div>
      </section>

      </section>
    </div>
  </main>

  <div id="modal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-slate-900/40"></div>
    <div class="relative mx-auto max-w-lg px-4 py-10">
      <div class="rounded-3xl bg-white border border-slate-200 shadow-card overflow-hidden">
        <div class="p-5 border-b border-slate-200 flex items-center justify-between">
          <div id="modalTitle" class="font-semibold">Details</div>
          <button id="modalClose" class="rounded-xl border border-slate-200 bg-white px-3 py-1.5 text-sm hover:bg-slate-50">Close</button>
        </div>
        <div id="modalBody" class="p-5 text-sm text-slate-700"></div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = "https://sheet2api.com/v1/Y6ffm9keQbKC/enriched_platform_listings";
    const INTERESTS = [{"ux": "Academic", "theme": "Academic", "hex": "#2563EB", "notes": "Academic clubs, honor societies, discipline-focused"}, {"ux": "Professional Development", "theme": "Professional Development", "hex": "#0EA5E9", "notes": "Career, networking, pre-professional"}, {"ux": "Cultural & Identity", "theme": "Cultural / Identity-Based", "hex": "#F59E0B", "notes": "Identity-centered orgs (ethnic, intl, affinity)"}, {"ux": "Faith & Spirituality", "theme": "Religious / Spiritual", "hex": "#7C3AED", "notes": "All faith-based or spiritual orgs"}, {"ux": "Service & Volunteering", "theme": "Service / Volunteering", "hex": "#10B981", "notes": "Community service, volunteering, philanthropy"}, {"ux": "Political & Activism", "theme": "Political / Activism", "hex": "#EF4444", "notes": "Advocacy, politics, activism"}, {"ux": "Arts & Media", "theme": "Arts & Media", "hex": "#EC4899", "notes": "Creative, performance, media, design"}, {"ux": "Sports & Athletics", "theme": "Sports & Athletics", "hex": "#F97316", "notes": "Competitive sports & athletics"}, {"ux": "Recreational / Social", "theme": "Recreational", "hex": "#22C55E", "notes": "Social, casual, hobby-based orgs"}];
    const MAJORS = ["üí∏ Accounting", "üìä Actuarial Science", "‚åö Advertising and PR", "üöÄ Aerospace Engineering", "üå± Agricultural Economics", "üöú Agricultural Engineering", "üå± Agriculture", "üåæ Agriculture Production and Mgmt", "üêº Animal Sciences", "üíØ Applied Mathematics", "üè¢ Architectural Engineering", "üè¢ Architecture", "üé® Art and Music Edu", "‚öóÔ∏è Biochemical Sciences", "‚öóÔ∏è Biological Engineering", "üî¨ Biology", "‚öïÔ∏è Biomedical Engineering", "üß¨ Biomedical Sciences", "üß¨ Biophysics", "üåø Botany", "üßë‚Äçüíº Business Analytics", "üíº Business Management", "üíº Business and Managerial Economics", "üí∞ Business and Marketing", "üí∏ Business and Quantitative Economics", "‚öôÔ∏è Chemical Engineering", "üß™ Chemistry", "üßë‚Äç‚öïÔ∏è Child and Family Studies", "üë©‚Äç‚öïÔ∏è Clinical Psychology", "üíª Computer Engineering", "üíª Computer Programming", "üíª Computer Science", "üì£ Communication Studies", "üó£Ô∏è Communications", "üßë‚Äçüåæ Community and Public Health", "üß± Construction Services", "üßÆ Critical Information Science", "üèõÔ∏è Criminal Justice", "üß¨ Cognitive Science and Biopsychology", "üß† Cognitive Science", "üç¥ Culinary Arts", "ü¶∑ Dental Hygiene", "ü¶∑ Dentistry", "üíé Diamond Science", "üåç Earth Sciences", "üìö Early Childhood Education", "üí° Economics", "üßë‚Äçüè´ Education Administration and Supervision", "üßë‚Äçüè´ Education", "üè≠ Electrical Engineering", "üéì Elementary Education", "üîß Engineering Mechanics", "‚öôÔ∏è Engineering and Business", "üîß Engineering", "üåé English Language and Literature", "‚úçÔ∏è English Literature", "üåø Environmental Science", "üåø Environmental Studies", "üßë‚Äçüåæ Family and Consumer Sciences", "üßØ Fire Protection Services", "üêü Fishery Sciences", "üìà Finance", "üçΩÔ∏è Food Science", "üßë‚Äçüåæ Forestry", "üé¨ Film and Video Studies", "üåê Foreign Language Education", "üåê Foreign Languages", "üß† General Psychology", "üéì General Education", "üß† General Social Sciences", "üß¨ Genetics", "üåç Geography", "üåã Geology", "üåé Geoscience", "üè• Health Administration", "üßë‚Äç‚öïÔ∏è Health Sciences", "üßë‚Äç‚öïÔ∏è Health and Medical Administrative Services", "üß¨ Health and Medical Sciences", "üßë‚Äç‚öïÔ∏è Health and Social Services", "üßë‚Äç‚öïÔ∏è Health", "üìú History", "üè® Hospitality and Tourism", "üè• Human Resources and Personnel Management", "üßç Human Services", "üß© Human Development and Family Studies", "üß† Human Biology", "üß™ Human Nutrition", "üå± Horticulture", "üí° Industrial Engineering", "üè≠ Industrial Production Technologies", "üì° Information Science", "üì∞ Information Systems", "üåê Information Technology", "üßë‚Äç‚öñÔ∏è International Business", "ü§å International Relations", "üåç International Studies", "üé• Journalism", "‚öñÔ∏è Judicial Systems", "üßë‚Äç‚öïÔ∏è Kinesiology and Exercise Science", "üîß Liberal Arts", "üßë‚Äç‚öñÔ∏è Legal Studies", "üó£Ô∏è Linguistics", "üó£Ô∏è Linguistics and Comparative Language and Literature", "üõí Logistics and Ecommerce", "‚öì Marine Engineering", "üè∑Ô∏è Marketing", "üìê Mathematics", "üè• Medical Assisting Services", "üßë‚Äç‚öïÔ∏è Medical Science", "üß† Mental Health", "‚öôÔ∏è Mechanical Engineering", "üß™ Microbiology", "üéº Music", "üß† Neuroscience", "üßë‚Äç‚öïÔ∏è Nursing", "üè• Nutrition and Food Sciences", "üß¨ Nutrition Sciences", "üè• Occupational Therapy", "üß† Organizational Behavior Studies", "üë∂ Pediatrics", "üè• Pharmacy", "üßë‚Äç‚öïÔ∏è Physical Therapy", "‚öõÔ∏è Physics", "üåø Plant Science", "üèõÔ∏è Political Science", "üíª Programming Languages", "üß† Psychiatry", "üßë‚Äç‚öïÔ∏è Public Health", "üì¢ Public Relations", "üß† Psychology", "üìö Reading Education", "üßë‚Äçüî¨ Research and Experimental Psychology", "üè• Respiratory Therapy", "üßë‚Äç‚öïÔ∏è Rehabilitation Services", "üìö Secondary Education", "üß™ Science and Technology Studies", "üßë‚Äç‚öïÔ∏è Social Work", "üó£Ô∏è Speech and Hearing Sciences", "üß† Sociology", "üß† Special Education", "üß™ Sport and Fitness Administration", "üèüÔ∏è Sports Management", "üßë‚Äç‚öïÔ∏è Sports Medicine", "üßë‚Äç‚öïÔ∏è Sports Sciences", "üèãÔ∏è Sports and Exercise Science", "üß† Statistics", "üìà Statistics and Data Science", "üé® Studio Arts", "üéí Teacher Edu", "‚õ™ Theology", "üöà Transportation Sciences", "ü§ó Treatment Therapy Professions", "üóΩ US History", "üê∂ Veterinary Medicine", "üé≠ Visual and Performing Arts", "üêØ Zoology"];

    const state = {
      data: null,
      interests: new Set(),
      themes: new Set(),
      year: "",
      majorDisplay: "",
      majorKey: "",
      preferActive: true,
      showWhy: true,
      debug: false,
      showReasoning: true,
      buildLog: null,
      wantsFaith: false,
      wantsIdentity: false,
      wantsAcademic: false,
      disciplineOptions: [],
      disciplineSelected: new Set(),
      disciplineOpen: false,
      faithOptions: [],
      identityOptions: [],
      faithSelected: new Set(),
      identitySelected: new Set(),
      faithOpen: false,
      identityOpen: false,
      scored: [],
      recommended: [],
      search: "",
      sort: "best",
    };

    const $ = (id) => document.getElementById(id);

    function openModal(title, html) {
      $("modalTitle").textContent = title;
      $("modalBody").innerHTML = html;
      $("modal").classList.remove("hidden");
    }
    function closeModal() {
      $("modal").classList.add("hidden");
    }
    $("modalClose").addEventListener("click", closeModal);
    $("modal").addEventListener("click", (e) => {
      if (e.target === $("modal") || e.target.classList.contains("bg-slate-900/40")) closeModal();
    });

    $("btnWhat").addEventListener("click", () => {
      openModal("What is this?", `
        <div class="space-y-2">
          <p>This is a UI/UX prototype for ActivityHub‚Äôs recommender.</p>
          <ul class="list-disc ml-5 text-slate-600 space-y-1">
            <li>Interests map to the API‚Äôs <code class="bg-slate-100 px-1.5 py-0.5 rounded text-xs">theme</code>.</li>
            <li>Year adjusts emphasis (explore vs career/leadership).</li>
            <li>Major boosts Academic/Professional orgs via <code class="bg-slate-100 px-1.5 py-0.5 rounded text-xs">associated_majors</code>.</li>
            <li>Guardrails: if you pick Faith/Cultural, you must specify communities (or choose Open).</li>
            <li>Optional: if you pick Academic, you can refine by Discipline (soft boost).</li>
            <li>Guarantee: at least <b>one</b> recommended org is related to your major (when possible).</li>
          </ul>
        </div>
      `);
    });

    function escapeHtml(s) {
      return String(s).replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[c]);
    }

    // Interests pills
    function renderInterestPills() {
      const root = $("interestPills");
      root.innerHTML = "";
      INTERESTS.forEach(item => {
        const selected = state.interests.has(item.ux);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "rounded-2xl border px-3 py-2.5 text-sm text-left hover:bg-slate-50 transition";
        btn.style.borderColor = selected ? item.hex : "#e2e8f0";
        btn.style.boxShadow = selected ? ("0 0 0 3px " + item.hex + "22") : "none";
        btn.innerHTML = `<span class="font-medium">${escapeHtml(item.ux)}</span>`;
        btn.addEventListener("click", () => {
          if (state.interests.has(item.ux)) {
            state.interests.delete(item.ux);
            state.themes.delete(item.theme);
          } else {
            state.interests.add(item.ux);
            state.themes.add(item.theme);
          }
          state.wantsFaith = state.interests.has("Faith & Spirituality");
          state.wantsIdentity = state.interests.has("Cultural & Identity");
          state.wantsAcademic = state.interests.has("Academic");
          maybeShowRefine();
          maybeShowAcademicRefine();
          renderReasoning();
          renderInterestPills();
          updateProfilePill();
        });
        root.appendChild(btn);
      });
    }

    $("btnClearInterests").addEventListener("click", () => {
      state.interests.clear();
      state.themes.clear();
      state.wantsFaith = false;
      state.wantsIdentity = false;
      state.wantsAcademic = false;
      state.faithSelected.clear();
      state.identitySelected.clear();
      state.disciplineSelected.clear();
      state.faithOpen = false;
      state.identityOpen = false;
      state.disciplineOpen = false;
      maybeShowRefine();
      maybeShowAcademicRefine();
      renderInterestPills();
      updateProfilePill();
      clearResults();
    });

    // Major autocomplete
    function normalizeMajorLabel(label) {
      try {
        return label.replace(/^\p{Extended_Pictographic}\s*/u, "").replace(/^\p{Emoji}\s*/u, "").trim();
      } catch {
        return label.replace(/^[^A-Za-z0-9]+\s*/, "").trim();
      }
    }

    function setMajor(v) {
      const clean = normalizeMajorLabel(v);
      state.majorDisplay = clean;
      state.majorKey = clean.toLowerCase();
      $("majorInput").value = clean;
      $("majorSuggestWrap").classList.add("hidden");
      updateProfilePill();
    }

    function renderMajorSuggest(q) {
      const wrap = $("majorSuggestWrap");
      const list = $("majorSuggest");
      const query = (q || "").trim().toLowerCase();
      if (!query) { wrap.classList.add("hidden"); return; }
      const matches = MAJORS.map(m => normalizeMajorLabel(m)).filter(m => m.toLowerCase().includes(query)).slice(0, 10);
      if (!matches.length) { wrap.classList.add("hidden"); return; }
      list.innerHTML = "";
      matches.forEach(m => {
        const row = document.createElement("button");
        row.type = "button";
        row.className = "w-full text-left px-4 py-2.5 text-sm hover:bg-slate-50 flex items-center justify-between";
        row.innerHTML = `<span class="truncate">${escapeHtml(m)}</span><span class="text-xs text-slate-500">Select</span>`;
        row.addEventListener("click", () => setMajor(m));
        list.appendChild(row);
      });
      wrap.classList.remove("hidden");
    }

    $("majorInput").addEventListener("input", (e) => {
      state.majorDisplay = e.target.value.trim();
      state.majorKey = state.majorDisplay.toLowerCase();
      renderMajorSuggest(state.majorDisplay);
      updateProfilePill();
    });

    $("yearSelect").addEventListener("change", (e) => {
      state.year = e.target.value;
      updateProfilePill();
    });

    $("preferActive").addEventListener("change", (e) => state.preferActive = e.target.checked);
    $("showWhy").addEventListener("change", (e) => { state.showWhy = e.target.checked; renderResults(); });
    $("debug").addEventListener("change", (e) => { state.debug = e.target.checked; renderResults(); });

    // Data loading
    async function loadData(force=false) {
      const key = "ah_mock_cache_v3";
      const ttl = 10 * 60 * 1000;
      if (!force) {
        try {
          const cached = JSON.parse(localStorage.getItem(key) || "null");
          if (cached && cached.data && cached.at && (Date.now() - cached.at) < ttl) {
            state.data = cached.data;
            return state.data;
          }
        } catch {}
      }
      const res = await fetch(API_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("API request failed: " + res.status);
      const data = await res.json();
      state.data = Array.isArray(data) ? data : [];
      localStorage.setItem(key, JSON.stringify({ data: state.data, at: Date.now() }));
      return state.data;
    }

    $("btnReload").addEventListener("click", async () => {
      try {
        await loadData(true);
        if (state.wantsFaith || state.wantsIdentity) await buildRefineOptions();
        if (state.wantsAcademic) await buildAcademicRefineOptions();
        rerun();
      } catch (e) {
        openModal("Reload failed", `<div class="text-red-700">${escapeHtml(e.message || String(e))}</div>`);
      }
    });

    // Domain tag parsing + refine
    function extractTagsFromDomain(domainStr) {
      const tags = { faith: [], identity: [] };
      const s = (domainStr || "").toString();
      const parts = s.split(",").map(x => x.trim()).filter(Boolean);
      for (const t of parts) {
        const lower = t.toLowerCase();
        if (lower.startsWith("faith:")) {
          const v = t.split(":").slice(1).join(":").trim();
          if (v) tags.faith.push(v);
        }
        if (lower.startsWith("identity:")) {
          let v = t.split(":").slice(1).join(":").trim();
          const m = v.match(/^Other\((.*)\)$/i);
          if (m && m[1]) v = m[1].trim();
          if (v) tags.identity.push(v);
        }
      }
      return tags;
    }

    function buildFaithIdentityOptionsFromData(data) {
      const faithSet = new Set();
      const identitySet = new Set();
      for (const entry of data) {
        const tags = extractTagsFromDomain(entry.domain);
        tags.faith.forEach(f => faithSet.add(f));
        tags.identity.forEach(i => identitySet.add(i));
      }
      state.faithOptions = Array.from(faithSet).sort((a,b)=>a.localeCompare(b));
      state.identityOptions = Array.from(identitySet).sort((a,b)=>a.localeCompare(b));
    }

    async function buildRefineOptions() {
      $("refineWrap").classList.remove("hidden");
      $("refineLoading").classList.remove("hidden");
      $("refineBody").classList.add("hidden");
      const data = state.data || await loadData(false);
      buildFaithIdentityOptionsFromData(data);
      renderRefine();
      $("refineLoading").classList.add("hidden");
      $("refineBody").classList.remove("hidden");
    }

    function maybeShowRefine() {
      const show = state.wantsFaith || state.wantsIdentity;
      $("refineWrap").classList.toggle("hidden", !show);
      if (!show) return;
      if (state.data) {
        buildFaithIdentityOptionsFromData(state.data);
        renderRefine();
        $("refineLoading").classList.add("hidden");
        $("refineBody").classList.remove("hidden");
      } else {
        $("refineLoading").classList.remove("hidden");
        $("refineBody").classList.add("hidden");
      }
    }

    function renderTagButtons(kind, options, selectedSet, openFlagId) {
      const rootId = (kind === "faith") ? "faithTags" : (kind === "identity") ? "identityTags" : "disciplineTags";
      const root = $(rootId);
      if (!root) return;
      root.innerHTML = "";

      const openEl = openFlagId ? $(openFlagId) : null;
      const isOpen = !!(openEl && openEl.checked);

      // For Discipline refinement we keep buttons clickable even when Open is checked,
      // so a user can click a discipline to automatically turn Open off.
      const disableButtons = isOpen && kind !== "discipline";

      options.forEach(val => {
        const selected = selectedSet.has(val);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "rounded-full border border-slate-200 bg-white px-3 py-1.5 text-sm hover:bg-slate-50";
        if (selected) btn.classList.add("bg-slate-900","text-white","border-slate-900");
        btn.textContent = val;
        btn.disabled = disableButtons;
        btn.classList.toggle("opacity-50", disableButtons);
        btn.addEventListener("click", () => {
          // If the user clicks a discipline while Open is on, auto-disable Open.
          if (kind === "discipline" && openEl && openEl.checked) {
            openEl.checked = false;
            state.disciplineOpen = false;
          }
          if (selectedSet.has(val)) selectedSet.delete(val);
          else selectedSet.add(val);
          if (kind === "discipline") renderAcademicRefine();
          else renderRefine();
        });
        root.appendChild(btn);
      });
    }

    function renderRefine() {
      $("faithBox").classList.toggle("hidden", !state.wantsFaith);
      $("identityBox").classList.toggle("hidden", !state.wantsIdentity);
      $("faithOpen").checked = state.faithOpen;
      $("identityOpen").checked = state.identityOpen;
      renderTagButtons("faith", state.faithOptions, state.faithSelected, "faithOpen");
      renderTagButtons("identity", state.identityOptions, state.identitySelected, "identityOpen");
    }


    // --- Academic (Discipline) refinement ---
    function extractDisciplinesFromDomain(domainStr) {
      const tokens = parseDomainTokens(domainStr);
      const out = [];
      for (const t of tokens) {
        const k = (t.kind || "").toString().trim().toLowerCase();
        if (k === "discipline") {
          const v = (t.value || "").toString().trim();
          if (v) out.push(v);
        }
      }
      return out;
    }

    function buildDisciplineOptionsFromData(data) {
      const set = new Set();
      for (const entry of data) {
        for (const d of extractDisciplinesFromDomain(entry.domain)) set.add(d);
      }
      state.disciplineOptions = Array.from(set).sort((a,b)=>a.localeCompare(b));
    }

    async function buildAcademicRefineOptions() {
      $("academicRefineWrap").classList.remove("hidden");
      $("academicRefineLoading").classList.remove("hidden");
      $("academicRefineBody").classList.add("hidden");
      const data = state.data || await loadData(false);
      buildDisciplineOptionsFromData(data);
      renderAcademicRefine();
      $("academicRefineLoading").classList.add("hidden");
      $("academicRefineBody").classList.remove("hidden");
    }

    function maybeShowAcademicRefine() {
      const show = !!state.wantsAcademic;
      $("academicRefineWrap").classList.toggle("hidden", !show);
      if (!show) return;
      if (state.data) {
        buildDisciplineOptionsFromData(state.data);
        renderAcademicRefine();
        $("academicRefineLoading").classList.add("hidden");
        $("academicRefineBody").classList.remove("hidden");
      } else {
        $("academicRefineLoading").classList.remove("hidden");
        $("academicRefineBody").classList.add("hidden");
      }
    }

    function renderAcademicRefine() {
      const open = $("disciplineOpen");
      if (open) open.checked = !!state.disciplineOpen;
      renderTagButtons("discipline", state.disciplineOptions, state.disciplineSelected, "disciplineOpen");
    }

    // Discipline Open toggle
    document.addEventListener("change", (e) => {
      if (!e || !e.target) return;
      if (e.target.id === "disciplineOpen") {
        state.disciplineOpen = !!e.target.checked;
        if (state.disciplineOpen) state.disciplineSelected.clear();
        renderAcademicRefine();
      }
    });

    $("faithOpen").addEventListener("change", (e) => {
      state.faithOpen = e.target.checked;
      if (state.faithOpen) state.faithSelected.clear();
      renderRefine();
    });
    $("identityOpen").addEventListener("change", (e) => {
      state.identityOpen = e.target.checked;
      if (state.identityOpen) state.identitySelected.clear();
      renderRefine();
    });

    // Scoring
    function parseAssociatedMajors(str) {
      const out = {};
      if (!str || typeof str !== "string") return out;
      const parts = str.split(",").map(s => s.trim()).filter(Boolean);
      for (const p of parts) {
        const m = p.match(/^(.*?)(?:\s*\((\d+(?:\.\d+)?)%\))?$/);
        if (!m) continue;
        const name = (m[1] || "").trim();
        const pct = m[2] ? Number(m[2]) / 100 : 0.0;
        if (!name) continue;
        out[name.toLowerCase()] = isFinite(pct) ? pct : 0.0;
      }
      return out;
    }

    function isVerified(entry) {
      const v = (entry.verified || "").toString().toLowerCase();
      return v === "yes" || v === "true";
    }

    function activityScore(entry) {
      const n = Number(entry.activity_score);
      return isFinite(n) ? n : 0;
    }

    const IDENTITY_KEYWORDS = [
      "black","african","latino","latina","hispanic","asian",
      "jewish","muslim","islam","christian","catholic","hindu","sikh","orthodox","coptic",
      "bengali","albanian","caribbean","filipino","korean","chinese","pakistani","bangladeshi",
      "naba","alpfa"
    ];

    function isIdentityAffiliated(entry) {
      const tags = extractTagsFromDomain(entry.domain);
      if (tags.faith.length || tags.identity.length) return true;
      const n = (entry.name || "").toString().toLowerCase();
      return IDENTITY_KEYWORDS.some(k => n.includes(k));
    }

    function yearWeights(year) {
      const base = { career: 1.0, explore: 1.0 };
      switch ((year || "").toLowerCase()) {
        case "freshman": return {...base, career: 0.85, explore: 1.20};
        case "sophomore": return {...base, career: 1.00, explore: 1.05};
        case "junior": return {...base, career: 1.25, explore: 0.95};
        case "senior": return {...base, career: 1.35, explore: 0.90};
        case "graduate": return {...base, career: 1.40, explore: 0.85};
        default: return base;
      }
    }

    function majorRelated(entry) {
      const theme = (entry.theme || "").toString();
      const careerTheme = theme === "Academic" || theme === "Professional Development";
      if (!careerTheme) return { ok:false, rel:0, reason:"" };

      const amap = parseAssociatedMajors(entry.associated_majors || "");
      const rel = state.majorKey ? (amap[state.majorKey] || 0) : 0;

      const name = (entry.name || "").toString().toLowerCase();
      const majorWord = (state.majorDisplay || "").toString().toLowerCase();
      const nameHit = majorWord && majorWord.length >= 4 && name.includes(majorWord);

      const ok = (rel > 0) || nameHit;

      let reason = "";
      if (rel > 0 && state.majorDisplay) reason = `it‚Äôs tagged as related to ${state.majorDisplay}`;
      else if (nameHit && state.majorDisplay) reason = `its name mentions ${state.majorDisplay}`;

      return { ok, rel: rel || (nameHit ? 0.10 : 0), reason };
    }

    function computeScore(entry) {
      const why = [];
      const dbg = {};
      let score = 0;

      const theme = (entry.theme || "").toString();
      const tags = extractTagsFromDomain(entry.domain);
      const weights = yearWeights(state.year);
      const isCareerTheme = theme === "Academic" || theme === "Professional Development";

      if (!state.wantsFaith && tags.faith.length) return null;
      if (!state.wantsIdentity && tags.identity.length) return null;

      if (state.wantsFaith && theme === "Religious / Spiritual" && !state.faithOpen) {
        const overlap = tags.faith.some(x => state.faithSelected.has(x));
        if (!overlap) return null;
      }
      if (state.wantsIdentity && theme === "Cultural / Identity-Based" && !state.identityOpen) {
        const overlap = tags.identity.some(x => state.identitySelected.has(x));
        if (!overlap) return null;
      }

      if (isCareerTheme && isIdentityAffiliated(entry)) {
        const okFaith = state.wantsFaith && (state.faithOpen || tags.faith.some(x => state.faithSelected.has(x)));
        const okIdent = state.wantsIdentity && (state.identityOpen || tags.identity.some(x => state.identitySelected.has(x)));
        if (!(okFaith || okIdent)) return null;
      }

      let interestPts = 0;
      if (state.themes.has(theme)) {
        interestPts = (isCareerTheme ? 55 : 45) * (isCareerTheme ? weights.career : weights.explore);
        score += interestPts;
        const ux = INTERESTS.find(x => x.theme === theme)?.ux || theme;
        why.push(`Matches your interests: ${ux}`);
      } else {
        score += 4;
      }
      dbg.interestPts = interestPts;

      let majorPts = 0;
      let relPct = 0;
      if (isCareerTheme && state.majorKey) {
        const m = majorRelated(entry);
        relPct = m.rel || 0;
        if (m.ok) {
          majorPts = (relPct * 60) * weights.career;
          score += majorPts;
          why.push(`Good for your major (${state.majorDisplay})`);
        }
      }
      dbg.majorPts = majorPts;
      dbg.majorRel = relPct;

      let disciplinePts = 0;
      if (state.wantsAcademic && isCareerTheme && !state.disciplineOpen && state.disciplineSelected.size) {
        const discs = extractDisciplinesFromDomain(entry.domain);
        const picked = new Set(Array.from(state.disciplineSelected).map(x => String(x||"").toLowerCase()));
        const hit = discs.find(d => picked.has(String(d||"").toLowerCase()));
        if (hit) {
          disciplinePts = 18 * weights.career;
          score += disciplinePts;
          why.push(`Discipline focus: ${hit}`);
        }
      }
      dbg.disciplinePts = disciplinePts;

      if (isCareerTheme && weights.career >= 1.2) why.push(`Strong for ${state.year}s (career + leadership)`);
      else if (!isCareerTheme && weights.explore >= 1.15) why.push(`Great for ${state.year}s (explore + community)`);

      let activePts = 0;
      if (state.preferActive) {
        const a = activityScore(entry);
        if (a) {
          activePts = Math.min(12, a * 2);
          score += activePts;
          if (a >= 4) why.push("Looks active (high confidence)");
        }
      }
      dbg.activePts = activePts;

      let verifiedPts = 0;
      if (isVerified(entry)) {
        verifiedPts = 6;
        score += verifiedPts;
        why.push("Verified");
      }
      dbg.verifiedPts = verifiedPts;

      return { entry, score, why: why.slice(0,3), dbg };
    }

    // Search/sort and guarantee
    function applySearchAndSort(list) {
      const q = (state.search || "").trim().toLowerCase();
      let out = list;
      if (q) {
        out = out.filter(x => {
          const e = x.entry;
          const blob = `${e.name||""} ${e.tagline||""} ${e.description_preview||""} ${e.domain||""}`.toLowerCase();
          return blob.includes(q);
        });
      }
      const sort = state.sort || "best";
      if (sort === "best") out = out.slice().sort((a,b)=>b.score-a.score);
      else if (sort === "activity") out = out.slice().sort((a,b)=> (activityScore(b.entry)-activityScore(a.entry)) || (b.score-a.score));
      else if (sort === "major") out = out.slice().sort((a,b)=> (b.dbg.majorRel-a.dbg.majorRel) || (b.score-a.score));
      else if (sort === "az") out = out.slice().sort((a,b)=> String(a.entry.name||"").localeCompare(String(b.entry.name||"")));
      return out;
    }

    function enforceMajorGuarantee(scoredList, topN=5) {
      const top = scoredList.slice(0, topN);
      const hasMajor = top.some(x => majorRelated(x.entry).ok);
      if (hasMajor) return top;
      const candidate = scoredList.find(x => majorRelated(x.entry).ok);
      if (!candidate) return top;
      const replaced = top.slice(0, Math.max(0, topN-1)).concat([candidate]);
      const seen = new Set();
      const unique = [];
      for (const x of replaced) {
        const k = (x.entry.name||"").toString().toLowerCase();
        if (seen.has(k)) continue;
        seen.add(k);
        unique.push(x);
      }
      return unique.slice(0, topN);
    }

    
    function matchesFaithPrefs(entry) {
      const tags = extractTagsFromDomain(entry.domain);
      const isFaithish = (String(entry.theme || "") === "Religious / Spiritual") || (tags.faith && tags.faith.length);
      if (!state.wantsFaith) return false;
      if (state.faithOpen) return isFaithish;
      return tags.faith.some(x => state.faithSelected.has(x));
    }

    function matchesIdentityPrefs(entry) {
      const tags = extractTagsFromDomain(entry.domain);
      const isIdentityish = (String(entry.theme || "") === "Cultural / Identity-Based") || (tags.identity && tags.identity.length);
      if (!state.wantsIdentity) return false;
      if (state.identityOpen) return isIdentityish;
      return tags.identity.some(x => state.identitySelected.has(x));
    }

    function matchesDisciplinePrefs(entry) {
      if (!state.wantsAcademic) return false;
      if (!["Academic","Professional Development"].includes(String(entry.theme || ""))) return false;
      if (state.disciplineOpen || !state.disciplineSelected.size) return false;
      const discs = extractDisciplinesFromDomain(entry.domain);
      const picked = new Set(Array.from(state.disciplineSelected).map(x => String(x||"").toLowerCase()));
      return discs.some(d => picked.has(String(d||"").toLowerCase()));
    }


    function stageMode() {
      const y = (state.year || "").toLowerCase();
      if (["junior","senior","graduate"].includes(y)) return "career_first";
      if (["freshman","sophomore"].includes(y)) return "explore_first";
      return "balanced";
    }

    function bestMajorAnchor(ordered) {
      return ordered.find(x => majorRelated(x.entry).ok) || null;
    }

    function bestPayoff(ordered) {
      const faithPick = state.wantsFaith ? (ordered.find(x => matchesFaithPrefs(x.entry)) || null) : null;
      const identPick = state.wantsIdentity ? (ordered.find(x => matchesIdentityPrefs(x.entry)) || null) : null;
      const discPick = (state.wantsAcademic && !state.disciplineOpen && state.disciplineSelected.size)
        ? (ordered.find(x => matchesDisciplinePrefs(x.entry)) || null)
        : null;
      return { faithPick, identPick, discPick };
    }

    function selectWithVariety(ordered, topN=5) {
      const chosen = [];
      const used = new Set();

      const add = (item) => {
        if (!item) return false;
        const key = (item.entry.name || "").toString().toLowerCase();
        if (!key || used.has(key)) return false;
        chosen.push(item);
        used.add(key);
        return true;
      };

      const mode = stageMode();
      const majorAnchor = bestMajorAnchor(ordered);
      const { faithPick, identPick, discPick } = bestPayoff(ordered); // discPick kept for legacy helpers; discipline coverage is handled below

      // Payoffs are the "extra-step" refinements. Keep them visible near the top.
      // Priority: Faith -> Identity -> Discipline.
      const payoffListRaw = [faithPick, identPick].filter(Boolean);
      const payoffList = [];
      const seen = new Set();
      for (const it of payoffListRaw) {
        const k = (it.entry?.name || "").toString().toLowerCase();
        if (!k || seen.has(k)) continue;
        payoffList.push(it);
        seen.add(k);
      }
      const primaryPayoff = payoffList[0] || null;
      const secondaryPayoff = payoffList[1] || null;
      const tertiaryPayoff = payoffList[2] || null;

      // --- Slotting rules (stacking policy) ---
      // Career-first (Junior/Senior/Graduate):
      //   1/5 Major + career anchor (if available)
      //   2/5 Extra-step payoff (faith/identity) (if available)
      // Explore-first (Freshman/Sophomore):
      //   1/5 Extra-step payoff
      //   2/5 Major anchor
      // Balanced:
      //   If user did extra step, keep payoff in top 2; otherwise major first (if available)
      if (mode === "career_first") {
        add(majorAnchor) || add(primaryPayoff) || add(ordered[0]);
        if (chosen.length < topN) add(primaryPayoff) || add(secondaryPayoff) || add(ordered.find(x => !used.has((x.entry.name||"").toString().toLowerCase())));
      } else if (mode === "explore_first") {
        add(primaryPayoff) || add(majorAnchor) || add(ordered[0]);
        if (chosen.length < topN) add(majorAnchor) || add(secondaryPayoff) || add(ordered.find(x => !used.has((x.entry.name||"").toString().toLowerCase())));
      } else {
        if (primaryPayoff) {
          add(primaryPayoff) || add(majorAnchor) || add(ordered[0]);
          if (chosen.length < topN) add(majorAnchor) || add(secondaryPayoff);
        } else {
          add(majorAnchor) || add(ordered[0]);
        }
      }

      // If both payoff types exist, try to include the second payoff early (slot 3)
      if (chosen.length < topN && secondaryPayoff) add(secondaryPayoff);
      if (chosen.length < topN && tertiaryPayoff) add(tertiaryPayoff);


      // --- Discipline coverage (before any filler) ---
      // If user selected multiple disciplines, try to include one good match per discipline (when available)
      if (state.wantsAcademic && !state.disciplineOpen && state.disciplineSelected && state.disciplineSelected.size) {
        const norm = (s) => (s || "").toString().trim().toLowerCase();
        const selectedDisciplines = Array.from(state.disciplineSelected);
        for (const d of selectedDisciplines) {
          if (chosen.length >= topN) break;
          const pick = ordered.find(x => {
            const key = norm(x.entry?.name);
            if (!key || used.has(key)) return false;
            const discs = extractDisciplinesFromDomain(x.entry?.domain || "");
            return discs.some(v => norm(v) === norm(d));
          });
          add(pick);
        }
      }
      // --- Smart filler: use remaining slots to pick the most relevant remaining options ---
      // Priority (in order):
      //   1) satisfy any *uncovered* selected refinements (e.g., a second identity tag like Caribbean)
      //   2) match selected refinements (even if already satisfied once)
      //   3) match selected themes/interests
      //   4) then highest base score
      const norm = (s) => (s || "").toString().trim().toLowerCase();

      const selectedThemes = new Set(Array.from(state.themes || []).map(String));
      const selectedFaith = new Set(Array.from(state.faithSelected || []).map(norm));
      const selectedIdentity = new Set(Array.from(state.identitySelected || []).map(norm));
      const selectedDisc = new Set(Array.from(state.disciplineSelected || []).map(norm));

      const covered = {
        faith: new Set(),
        identity: new Set(),
        discipline: new Set(),
        themes: new Set()
      };

      const updateCoveredFromItem = (item) => {
        if (!item || !item.entry) return;
        const theme = String(item.entry.theme || "");
        if (theme) covered.themes.add(theme);

        const tags = extractTagsFromDomain(item.entry.domain || "");
        for (const f of (tags.faith || [])) {
          const k = norm(f);
          if (selectedFaith.has(k)) covered.faith.add(k);
        }
        for (const i of (tags.identity || [])) {
          const k = norm(i);
          if (selectedIdentity.has(k)) covered.identity.add(k);
        }
        const discs = extractDisciplinesFromDomain(item.entry.domain || "");
        for (const d of discs) {
          const k = norm(d);
          if (selectedDisc.has(k)) covered.discipline.add(k);
        }
      };

      // initialize covered based on what we already chose in the "promise coverage" phase
      for (const it of chosen) updateCoveredFromItem(it);

      const calcRelevanceBonus = (item) => {
        const e = item.entry || {};
        const theme = String(e.theme || "");
        const domain = e.domain || "";

        const tags = extractTagsFromDomain(domain);
        const faithTags = (tags.faith || []).map(norm);
        const identTags = (tags.identity || []).map(norm);
        const discs = extractDisciplinesFromDomain(domain).map(norm);

        // Hits to selected refinements
        const faithHits = (state.wantsFaith && !state.faithOpen) ? faithTags.filter(x => selectedFaith.has(x)) : [];
        const identHits = (state.wantsIdentity && !state.identityOpen) ? identTags.filter(x => selectedIdentity.has(x)) : [];
        const discHits  = (state.wantsAcademic && !state.disciplineOpen) ? discs.filter(x => selectedDisc.has(x)) : [];

        // Uncovered hits are "more valuable" when filling remaining slots
        const faithUncovered = faithHits.filter(x => !covered.faith.has(x));
        const identUncovered = identHits.filter(x => !covered.identity.has(x));
        const discUncovered  = discHits.filter(x => !covered.discipline.has(x));

        let bonus = 0;

        // 1) Uncovered refinements (strongest)
        bonus += faithUncovered.length * 70;
        bonus += identUncovered.length * 80;
        bonus += discUncovered.length  * 75;

        // 2) Any refinement match (still meaningful)
        bonus += faithHits.length * 25;
        bonus += identHits.length * 30;
        bonus += discHits.length  * 28;

        // 3) Theme/interest alignment
        if (selectedThemes.has(theme)) bonus += 20;

        // 4) Encourage variety across selected themes (light)
        // If the theme is selected but not yet represented, give a small bump.
        if (selectedThemes.has(theme) && !covered.themes.has(theme)) bonus += 18;

        return bonus;
      };

      while (chosen.length < topN) {
        let best = null;
        let bestScore = -Infinity;

        for (const x of ordered) {
          const key = norm(x.entry?.name);
          if (!key || used.has(key)) continue;

          const base = (typeof x.score === "number" ? x.score : 0);
          const bonus = calcRelevanceBonus(x);

          const total = base + bonus;
          if (total > bestScore) {
            bestScore = total;
            best = x;
          }
        }

        if (!best) break;
        add(best);
        updateCoveredFromItem(best);
      }

      return chosen.slice(0, topN);
    }

    function enforceMajorGuaranteeOnChosen(chosen, ordered, topN=5) {
      const hasMajor = chosen.some(x => majorRelated(x.entry).ok);
      if (hasMajor) return chosen.slice(0, topN);

      const candidate = ordered.find(x => majorRelated(x.entry).ok);
      if (!candidate) return chosen.slice(0, topN);

      const key = (candidate.entry.name || "").toString().toLowerCase();
      const exists = chosen.some(x => (x.entry.name||"").toString().toLowerCase() === key);
      if (exists) return chosen.slice(0, topN);

      // Keep top-slot intent intact: replace LAST slot if full.
      const out = chosen.slice(0, topN);
      if (out.length < topN) out.push(candidate);
      else out[out.length - 1] = candidate;
      return out.slice(0, topN);
    }


    function updateCoverageBanner(ordered, chosen) {
      const msgs = [];

      if (state.wantsFaith) {
        const hasFaith = chosen.some(x => matchesFaithPrefs(x.entry));
        if (!hasFaith) {
          const anyFaith = ordered.some(x => (extractTagsFromDomain(x.entry.domain).faith || []).length || String(x.entry.theme||"") === "Religious / Spiritual");
          if (!anyFaith) msgs.push("We couldn‚Äôt find any faith-tagged orgs in the data right now.");
          else msgs.push("No matches found for your selected faith community. Try selecting ‚ÄúOpen‚Äù or add another faith to widen results.");
        }
      }

      if (state.wantsIdentity) {
        const hasIdentity = chosen.some(x => matchesIdentityPrefs(x.entry));
        if (!hasIdentity) {
          const anyIdent = ordered.some(x => (extractTagsFromDomain(x.entry.domain).identity || []).length || String(x.entry.theme||"") === "Cultural / Identity-Based");
          if (!anyIdent) msgs.push("We couldn‚Äôt find any identity-tagged orgs in the data right now.");
          else msgs.push("No matches found for your selected identity community. Try selecting ‚ÄúOpen‚Äù or choose more communities to widen results.");
        }
      }

      if (state.wantsAcademic && !state.disciplineOpen && state.disciplineSelected.size) {
        const hasDisc = chosen.some(x => matchesDisciplinePrefs(x.entry));
        if (!hasDisc) {
          const anyDisc = ordered.some(x => ["Academic","Professional Development"].includes(String(x.entry.theme||"")) && extractDisciplinesFromDomain(x.entry.domain).length);
          if (!anyDisc) msgs.push("We couldn‚Äôt find any discipline-tagged Academic/Professional orgs in the data right now.");
          else msgs.push("No Academic/Professional matches found for your selected discipline. Try selecting ‚ÄòOpen‚Äô or pick an additional discipline.");
        }
      }

      const el = $("coverageBanner");
      const txt = $("coverageBannerText");
      if (!msgs.length) {
        el.classList.add("hidden");
        txt.textContent = "";
      } else {
        el.classList.remove("hidden");
        txt.innerHTML = msgs.map(m => `<div>‚Ä¢ ${escapeHtml(m)}</div>`).join("");
      }
    }

    
    function computeRoleForSlot(item, index) {
      const e = item.entry || {};
      if (majorRelated(e).ok) return "Major + career anchor";
      if (matchesFaithPrefs(e)) return "Faith payoff";
      if (matchesIdentityPrefs(e)) return "Identity payoff";
      if (matchesDisciplinePrefs(e)) return "Discipline match";
      const t = String(e.theme || "");
      const themeMap = {
        "Academic": "Academic",
        "Professional Development": "Professional Development",
        "Cultural / Identity-Based": "Cultural & Identity",
        "Religious / Spiritual": "Faith & Spirituality",
        "Service / Volunteering": "Service & Volunteering",
        "Political / Activism": "Political & Activism",
        "Arts & Media": "Arts & Media",
        "Sports & Athletics": "Sports & Athletics",
        "Recreational": "Recreational / Social"
      };
      if (state.themes.has(t)) return `Interest match (${themeMap[t] || t})`;
      return "Best overall";
    }

    function buildRecommended() {
      const ordered = applySearchAndSort(state.scored);
      let chosen = selectWithVariety(ordered, 5);
      chosen = enforceMajorGuaranteeOnChosen(chosen, ordered, 5);
      state.recommended = chosen;

      const mode = stageMode();
      const hasDisciplineFocus = !!(state.wantsAcademic && !state.disciplineOpen && state.disciplineSelected.size);
      let ruleSummary = "";
      const payoffLabel = hasDisciplineFocus ? "faith/identity (and discipline focus)" : "faith/identity";
      if (mode === "career_first") ruleSummary = `Slot #1 prioritizes major/career fit; Slot #2 prioritizes your refined ${payoffLabel} (if available).`;
      else if (mode === "explore_first") ruleSummary = `Slot #1 prioritizes your refined ${payoffLabel} (if available); Slot #2 prioritizes major/career fit.`;
      else ruleSummary = `Top slots prioritize your refined ${payoffLabel} and major fit when applicable, then fill with interest variety.`;

      const slots = (chosen || []).map((it, i) => {
        const name = (it.entry?.name || "Untitled").toString();
        const role = computeRoleForSlot(it, i);
        const because = (it.why && it.why.length ? it.why[0] : "high score");
        return { role, name, because };
      });

      state.buildLog = {
        stageLabel: humanStageLabel(),
        profileLine: shortProfileLine(),
        narrative: stageStackNarrative(),
        items: (chosen || []).map((it, idx) => ({
          name: (it.entry?.name || "Untitled").toString(),
          role: computeRoleForSlot(it, idx),
          scoreLabel: (typeof it.score === "number" ? ("Score " + it.score) : ""),
          reasons: whyForItem(it, idx)
        }))
      };

      updateCoverageBanner(ordered, chosen);
      renderReasoning();
    }


    // Card rendering (FIXES your "Faith pill on everything" issue)
    function badge(text, cls="") {
      return `<span class="rounded-full border border-slate-200 bg-white px-2.5 py-1 text-xs text-slate-600 ${cls}">${escapeHtml(text)}</span>`;
    }

    // --- Tag label + emoji helpers (for domain chips) ---
    function normalizeTagValue(kind, valueRaw) {
      let v = (valueRaw || "").toString().trim();
      if (!v) return "";

      if (kind.toLowerCase() === "identity") {
        const mm = v.match(/^Other\((.*)\)$/i);
        if (mm && mm[1]) v = mm[1].trim();
      }
      // Clean common noise
      v = v.replace(/^Other\(/i, "").replace(/\)$/,"").trim();
      return v;
    }

        // --- Tag emoji mappings ---
    // Canonical emoji source-of-truth for majors comes from MAJORS (dropdown list).
    // We reuse those emojis anywhere a tag value matches a major label (Discipline + Industry).
    const MAJOR_EMOJI_MAP = (() => {
      const map = new Map();
      for (const raw of (MAJORS || [])) {
        const label = normalizeMajorLabel(raw);
        const m = String(raw || "").trim().match(/^(\S+)\s+/); // first token is the emoji
        if (!label || !m) continue;
        map.set(label.toLowerCase(), m[1]);
      }
      return map;
    })();

    // Hardcoded tag emojis for non-major domains (and for values that won't exist in the major list).
    // IMPORTANT: Identity "Other" must NOT use the people-holding-hands emoji ‚Äî we use a map.
    const TAG_EMOJIS = {
      faith: {
        "Catholicism": "‚õ™",
        "Christianity": "‚õ™",
        "Islam": "üïå",
        "Judaism": "üïç",
        "Hinduism": "üõï",
        "Buddhism": "üõï",
        "Sikhism": "üõï",
        "Interfaith": "ü§ù",
        "Spiritual / Non-denom": "‚ú®",
      },
      identity: {
        "African / African-American": "‚úäüèø",
        "Latino / Hispanic": "üåé",
        "South Asian": "ü™∑",
        "East Asian": "üèÆ",
        "Middle Eastern": "üßø",
        "LGBTQ+": "üè≥Ô∏è‚Äçüåà",
        "First-Generation": "üéì",
        "International Students": "üåç",
        "Women-Focused": "‚ôÄÔ∏è",
        "Greek Life": "üèõÔ∏è",
        // Any "Other(...)" or uncategorized identity ‚Üí map icon (requested)
        "__OTHER__": "üó∫Ô∏è",
      },
      cause: {
        "Community Service": "ü§ù",
        "Social Justice": "‚úä",
        "Environmental": "üåø",
        "Public Health": "üè•",
        "Education Access": "üéì",
        "Advocacy": "üì£",
        "Human Rights": "üïäÔ∏è",
        "Civic Engagement": "üó≥Ô∏è",
      },
      activity: {
        "Chess": "‚ôüÔ∏è",
        "Board Games": "üé≤",
        "Gaming": "üéÆ",
        "Esports": "üéÆ",
        "Dance": "üíÉ",
        "Music": "üéµ",
        "Fitness": "üèãÔ∏è",
        "Martial Arts": "ü•ã",
        "Outdoor Recreation": "üèûÔ∏è",
      },
      // Industry + Discipline will try MAJOR_EMOJI_MAP first; these are just fallbacks.
      industry: {
        "Business": "üíº",
        "Finance": "üí∞",
        "STEM": "üß™",
        "Law": "‚öñÔ∏è",
        "Healthcare": "üè•",
        "Education": "üßë‚Äçüè´",
        "Media / Journalism": "üóûÔ∏è",
        "Government / Policy": "üèõÔ∏è",
        "Design / Creative": "üé®",
      },
      discipline: {
        // Prefer MAJOR_EMOJI_MAP when possible
        "Accounting": "üí∏",
        "Finance": "üí∞",
        "Computer Science": "üíª",
        "Statistics": "üìà",
        "Data Science": "üìà",
      }
    };

    // Theme / interest emoji mapping (used for the theme pill shown on each card)
    const THEME_EMOJIS = {
      "Academic": "üìö",
      "Professional Development": "üíº",
      "Cultural & Identity": "üß≠",
      "Cultural / Identity-Based": "üß≠",
      "Faith & Spirituality": "üïäÔ∏è",
      "Religious / Spiritual": "üïäÔ∏è",
      "Service & Volunteering": "ü§ù",
      "Service / Volunteering": "ü§ù",
      "Political & Activism": "üì£",
      "Political / Activism": "üì£",
      "Arts & Media": "üé®",
      "Sports & Athletics": "üèÖ",
      "Recreational / Social": "üéØ",
      "Recreational": "üéØ",
    };

    function emojiForTheme(themeOrUx) {
      const key = (themeOrUx || "").toString().trim();
      return THEME_EMOJIS[key] || "üè∑Ô∏è";
    }


    function emojiForTag(kind, value) {
      const k = (kind || "").toString().trim().toLowerCase();
      const vRaw = (value || "").toString().trim();
      const v = vRaw.toLowerCase();

      // 1) If the tag value matches a major label, reuse the major emoji (requirement).
      // Applies mainly to Discipline + Industry, but harmless for others too.
      const majorHit = MAJOR_EMOJI_MAP.get(vRaw.toLowerCase());
      if (majorHit && (k === "discipline" || k === "industry")) return majorHit;

      // 2) Exact hardcoded mapping by category (case-insensitive match)
      const bucket = TAG_EMOJIS[k];
      if (bucket) {
        const exact = bucket[vRaw] || bucket[vRaw.replace(/\s+/g, " ").trim()];
        if (exact) return exact;
      }

      // 3) Soft matching for common variants (keeps UI resilient when the API adds new values)
      if (k === "faith") {
        if (v.includes("islam") || v.includes("muslim")) return "üïå";
        if (v.includes("jew")) return "üïç";
        if (v.includes("catholic") || v.includes("christ")) return "‚õ™";
        if (v.includes("hindu")) return "üõï";
        if (v.includes("buddh")) return "üõï";
        if (v.includes("sikh")) return "üõï";
        if (v.includes("interfaith")) return "ü§ù";
        return "üôè";
      }

      if (k === "identity") {
        // Any Identity:Other(...) or unknown identity ‚Üí map icon (requested)
        return (TAG_EMOJIS.identity.__OTHER__ || "üó∫Ô∏è");
      }

      if (k === "cause") {
        if (v.includes("environment")) return "üåø";
        if (v.includes("health")) return "üè•";
        if (v.includes("justice")) return "‚úä";
        if (v.includes("rights")) return "üïäÔ∏è";
        if (v.includes("advoc")) return "üì£";
        if (v.includes("civic") || v.includes("vote")) return "üó≥Ô∏è";
        return "ü§ù";
      }

      if (k === "activity") {
        if (v.includes("chess")) return "‚ôüÔ∏è";
        if (v.includes("board")) return "üé≤";
        if (v.includes("game") || v.includes("esport")) return "üéÆ";
        if (v.includes("dance")) return "üíÉ";
        if (v.includes("music")) return "üéµ";
        if (v.includes("fitness") || v.includes("gym")) return "üèãÔ∏è";
        if (v.includes("martial")) return "ü•ã";
        if (v.includes("outdoor") || v.includes("hike")) return "üèûÔ∏è";
        if (v.includes("theatre") || v.includes("theater") || v.includes("comedy")) return "üé≠";
        return "üéØ";
      }

      if (k === "discipline") {
        // If we didn't match a major label exactly, try a fuzzy match against major labels.
        // Example: "Data Science" should still reuse "Statistics and Data Science" if that's what exists.
        for (const [label, emo] of MAJOR_EMOJI_MAP.entries()) {
          if (label === v) return emo;
          if (label.includes(v) || v.includes(label)) return emo;
        }
        return "üéì";
      }

      if (k === "industry") {
        // Try fuzzy match against majors too
        for (const [label, emo] of MAJOR_EMOJI_MAP.entries()) {
          if (label === v) return emo;
          if (label.includes(v) || v.includes(label)) return emo;
        }
        const bucket2 = TAG_EMOJIS.industry || {};
        const exact2 = bucket2[vRaw] || bucket2[vRaw.replace(/\s+/g, " ").trim()];
        if (exact2) return exact2;
        return "üè¢";
      }

      return "üè∑Ô∏è";
    }

    function parseDomainTokens(domainStr) {
      const s = (domainStr || "").toString();
      const parts = s.split(",").map(x => x.trim()).filter(Boolean);
      const out = [];
      for (const raw of parts) {
        // ActivityOther(Theatre) style
        const act = raw.match(/^ActivityOther\((.*)\)$/i);
        if (act && act[1]) {
          out.push({ kind: "Activity", value: act[1].trim(), raw });
          continue;
        }
        if (raw.includes(":")) {
          const kind = raw.split(":")[0].trim();
          const value = raw.split(":").slice(1).join(":").trim();
          out.push({ kind, value: normalizeTagValue(kind, value), raw });
          continue;
        }
        out.push({ kind: "Tag", value: raw, raw });
      }
      return out;
    }

    function renderDomainChips(domainStr, themeCanonical, max=3) {
      const tokens = parseDomainTokens(domainStr);

      const order = ["Discipline", "Industry", "Cause", "Faith", "Identity", "Activity", "Tag"];
      tokens.sort((a,b) => order.indexOf(a.kind) - order.indexOf(b.kind));

      const seen = new Set();
      const chips = [];
      for (const t of tokens) {
        if (chips.length >= max) break;
        const val = (t.value || "").toString().trim();
        if (!val) continue;

        // Avoid repeating the main theme chip text
        if (themeCanonical && val.toLowerCase() === themeCanonical.toLowerCase()) continue;

        const key = (t.kind + ":" + val).toLowerCase();
        if (seen.has(key)) continue;
        seen.add(key);

        const emo = emojiForTag(t.kind, val);
        const label = (t.kind.toLowerCase() === "tag") ? val : val; // no prefixes in UI
        chips.push(badge(`${emo} ${label}`.trim()));
      }
      return chips.join("");
    }


    function themeMeta(theme) {
      return INTERESTS.find(x => x.theme === theme) || null;
    }

    function renderCard(item) {
      const e = item.entry;
      const logo = (e.logo_url || "").toString();
      const title = (e.name || "Untitled").toString();
      const school = (e.school || "").toString() || "St. John's University";
      const theme = (e.theme || "").toString();
      const tm = themeMeta(theme);
      const themeChip = tm ? badge(`${emojiForTheme(tm.ux)} ${tm.ux}`, "bg-slate-50") : (theme ? badge(`${emojiForTheme(theme)} ${theme}`, "bg-slate-50") : "");

      const subtitle = `${theme} ‚Ä¢ ${school}`;
      const domain = (e.domain || "").toString();
      const domainChips = domain ? renderDomainChips(domain, theme, 3) : "";

      const scorePill = `<span class="ml-auto rounded-full bg-blue-50 px-2.5 py-1 text-xs text-blue-700 border border-blue-100">Score ${Math.round(item.score)}</span>`;
      const activityPill = activityScore(e) >= 4 ? `<span class="rounded-full bg-emerald-50 px-2.5 py-1 text-xs text-emerald-700 border border-emerald-100">Activity High</span>` : ``;
      const verifiedPill = isVerified(e) ? `<span class="rounded-full bg-emerald-50 px-2.5 py-1 text-xs text-emerald-700 border border-emerald-100">Verified</span>` : ``;

      const showWhy = state.showWhy && item.why.length;
      const whyPills = showWhy ? item.why.map(w => `<span class="inline-flex rounded-full bg-slate-900 px-3 py-1.5 text-xs text-white">${escapeHtml(w)}</span>`).join("") : "";

      const dbg = state.debug ? `
        <div class="mt-2 text-xs text-slate-500">
          Debug: interest=${(item.dbg.interestPts||0).toFixed(1)} ‚Ä¢ major=${(item.dbg.majorPts||0).toFixed(1)} ‚Ä¢ discipline=${(item.dbg.disciplinePts||0).toFixed(1)} ‚Ä¢ active=${(item.dbg.activePts||0).toFixed(1)} ‚Ä¢ verified=${(item.dbg.verifiedPts||0).toFixed(1)}
        </div>
      ` : ``;

      const openBtn = `<button class="openBtn rounded-xl bg-blue-600 px-3 py-2 text-xs text-white hover:bg-blue-700" data-name="${escapeHtml(title)}">Open</button>`;
      const whyBtn = `<button class="whyBtn rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs hover:bg-slate-50" data-why="${escapeHtml(item.why.join(" ‚Ä¢ "))}" data-name="${escapeHtml(title)}">Why this?</button>`;

      return `
        <article class="rounded-3xl border border-slate-200 bg-white p-4 hover:shadow-soft transition">
          <div class="flex items-start gap-3">
            <div class="h-10 w-10 rounded-2xl bg-slate-100 border border-slate-200 overflow-hidden grid place-items-center flex-shrink-0">
              ${logo ? `<img src="${escapeHtml(logo)}" alt="" class="h-full w-full object-cover">` : `<span class="text-[10px] text-slate-500">logo</span>`}
            </div>
            <div class="min-w-0 flex-1">
              <div class="flex items-center gap-2">
                <div class="font-semibold text-slate-900 truncate">${escapeHtml(title)}</div>
                ${scorePill}
              </div>
              <div class="mt-0.5 text-xs text-slate-500 truncate">${escapeHtml(subtitle)}</div>

              <div class="mt-2 flex flex-wrap gap-2">
                ${themeChip}
                ${domainChips}
                ${verifiedPill}
                ${activityPill}
              </div>

              <div class="mt-3 text-sm text-slate-600 line-clamp-3">${escapeHtml((e.description_preview||e.tagline||"").toString())}</div>
              ${dbg}
              <div class="mt-4 flex items-center gap-2">
                ${whyBtn}
                ${openBtn}
              </div>
              ${showWhy ? `<div class="mt-3 flex flex-wrap gap-2">${whyPills}</div>` : ``}
            </div>
          </div>
        </article>
      `;
    }

    function attachCardHandlers() {
      document.querySelectorAll(".whyBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          const name = btn.dataset.name || "Why this?";
          const why = btn.dataset.why || "";
          openModal("Why this?", `
            <div class="space-y-2">
              <div class="font-semibold">${escapeHtml(name)}</div>
              <div class="text-slate-600">Top reasons:</div>
              <ul class="list-disc ml-5 text-slate-700">
                ${why.split(" ‚Ä¢ ").filter(Boolean).map(x => `<li>${escapeHtml(x)}</li>`).join("")}
              </ul>
            </div>
          `);
        });
      });

      document.querySelectorAll(".openBtn").forEach(btn => {
        btn.addEventListener("click", () => {
          openModal("Open", `<div class="text-slate-700">In the real app, this would open the org page for <b>${escapeHtml(btn.dataset.name||"")}</b>.</div>`);
        });
      });
    }

    
    
    function humanStageLabel() {
      const m = stageMode();
      if (m === "career_first") return "Career-first (Junior/Senior/Graduate)";
      if (m === "explore_first") return "Explore-first (Freshman/Sophomore)";
      return "Balanced";
    }

    function selectedInterestsFriendly() {
      const map = {
        "Academic": "Academic",
        "Professional Development": "Professional Development",
        "Cultural / Identity-Based": "Cultural & Identity",
        "Religious / Spiritual": "Faith & Spirituality",
        "Service / Volunteering": "Service & Volunteering",
        "Political / Activism": "Political & Activism",
        "Arts & Media": "Arts & Media",
        "Sports & Athletics": "Sports & Athletics",
        "Recreational": "Recreational / Social"
      };
      return Array.from(state.themes).map(t => map[t] || t);
    }

    function stageStackNarrative() {
      const y = state.year || "";
      const mode = stageMode();
      const hasDisciplineFocus = !!(state.wantsAcademic && !state.disciplineOpen && state.disciplineSelected.size);
      const payoffLabel = hasDisciplineFocus ? "faith/identity picks (and your discipline focus)" : "faith/identity picks";
      if (mode === "career_first") {
        return `Since you‚Äôre a ${y}, I‚Äôm putting major/career-related clubs first, and I‚Äôm still making sure your ${payoffLabel} show up near the top.`;
      }
      if (mode === "explore_first") {
        return `Since you‚Äôre a ${y}, I start with community matches (like faith or identity)${hasDisciplineFocus ? " and your discipline focus" : ""}, then I add something that fits your major/career path.`;
      }
      return `I‚Äôm balancing community + career: if you picked a faith/identity community${hasDisciplineFocus ? " (or a discipline focus)" : ""}, I keep that visible near the top, and I still try to include at least one major-related academic/professional club.`;
    }

    function shortProfileLine() {
      const interests = selectedInterestsFriendly();
      const bits = [];
      if (state.year) bits.push(state.year);
      if (state.majorDisplay) bits.push(state.majorDisplay);
      if (interests.length) bits.push(interests.join(", "));
      return bits.join(" ‚Ä¢ ");
    }

    function whyForItem(item, slotIndex) {
      const e = item.entry || {};
      const tags = extractTagsFromDomain(e.domain);
      const reasons = [];

      const mode = stageMode();
      if (slotIndex === 0) {
        if (mode === "career_first") reasons.push("I put this first because it‚Äôs a strong fit for your major/career right now.");
        else if (mode === "explore_first") reasons.push("I put this first because it matches what you said matters most to you.");
        else reasons.push("I put this near the top because it‚Äôs one of the strongest overall matches for your profile.");
      }

      const mr = majorRelated(e);
      if (mr.ok) reasons.push(`You‚Äôre majoring in ${state.majorDisplay}, and this is a close match (${mr.reason}).`);

      const theme = String(e.theme || "");
      if (state.themes.has(theme)) {
        const themeMap = {
          "Academic": "Academic",
          "Professional Development": "Professional Development",
          "Cultural / Identity-Based": "Cultural & Identity",
          "Religious / Spiritual": "Faith & Spirituality",
          "Service / Volunteering": "Service & Volunteering",
          "Political / Activism": "Political & Activism",
          "Arts & Media": "Arts & Media",
          "Sports & Athletics": "Sports & Athletics",
          "Recreational": "Recreational / Social"
        };
        const friendlyTheme = themeMap[theme] || theme;
        reasons.push(`You said you‚Äôre interested in ${friendlyTheme}, and this club fits that.`);
      }

      if (matchesFaithPrefs(e)) {
        if (state.faithOpen) reasons.push("You picked Faith & Spirituality and chose ‚ÄúOpen,‚Äù so I included a strong faith-based option.");
        else {
          const picked = Array.from(state.faithSelected);
          if (picked.length) reasons.push(`You told me your faith preference is (${picked.join(", ")}), so I made sure you saw at least one match.`);
          else reasons.push("You refined your faith preference, so I made sure you saw at least one match.");
        }
      }

      if (matchesIdentityPrefs(e)) {
        if (state.identityOpen) reasons.push("You picked Cultural & Identity and chose ‚ÄúOpen,‚Äù so I included a strong community match.");
        else {
          const picked = Array.from(state.identitySelected);
          if (picked.length) reasons.push(`You told me your identity/community preference is (${picked.join(", ")}), so I included a match.`);
          else reasons.push("You refined your identity preference, so I included a match.");
        }
      }

      if (matchesDisciplinePrefs(e)) {
        const picked = Array.from(state.disciplineSelected);
        const discs = extractDisciplinesFromDomain(e.domain);
        const hit = discs.find(d => picked.map(x=>String(x||"").toLowerCase()).includes(String(d||"").toLowerCase()));
        if (hit) reasons.push(`You asked for Academic recommendations focused on ${hit}, so this moved up.`);
        else reasons.push("You refined Academic by discipline, so I included a close discipline match.");
      }

      if (String(e.activity_score || "").toLowerCase().includes("high")) reasons.push("It also looks active, which usually means better events and consistency.");
      if (String(e.verified || "").toLowerCase() === "true" || e.verified === true) reasons.push("It‚Äôs verified, so it‚Äôs more trustworthy / official.");

      const isCareerTheme = (theme === "Academic" || theme === "Professional Development");
      if (isCareerTheme && isIdentityAffiliated(e)) {
        const okFaith = state.wantsFaith && (state.faithOpen || tags.faith.some(x => state.faithSelected.has(x)));
        const okIdent = state.wantsIdentity && (state.identityOpen || tags.identity.some(x => state.identitySelected.has(x)));
        if (okFaith || okIdent) reasons.push("Also: this is an identity-focused professional/academic org, and I only included it because it matches what you selected (or you set it to Open).");
      }

      return reasons.slice(0, 4);
    }

    function renderReasoning() {
      const panel = $("reasoningPanel");
      const root = $("reasoningText");
      if (!panel || !root) return;

      if (!state.showReasoning) {
        panel.classList.add("hidden");
        return;
      }
      panel.classList.remove("hidden");

      const log = state.buildLog;
      if (!log) {
        root.innerHTML = `<div class="text-slate-600">Pick interests and click <span class="font-medium">Get recommendations</span> to see the explanation.</div>`;
        return;
      }

      const header = `
        <div class="rounded-xl bg-white border border-slate-200 px-3 py-2">
          <div class="text-xs text-slate-500">Your profile</div>
          <div class="font-medium">${escapeHtml(log.profileLine)}</div>
        </div>
        <div class="mt-2">${escapeHtml(log.narrative)}</div>
        <div class="mt-2 text-slate-600">Here‚Äôs why each club showed up, in the exact order I stacked it:</div>
      `;

      const items = log.items.map((it, i) => {
        const bullets = (it.reasons || []).map(r => `<div class="text-slate-600">‚Ä¢ ${escapeHtml(r)}</div>`).join("");
        return `
          <div class="mt-3 rounded-xl border border-slate-200 bg-white px-3 py-3">
            <div class="flex items-start justify-between gap-3">
              <div>
                <div class="font-semibold">${i+1}. ${escapeHtml(it.name)}</div>
                <div class="text-xs text-slate-500">${escapeHtml(it.role)}</div>
              </div>
              <div class="text-xs text-slate-500">${escapeHtml(it.scoreLabel || "")}</div>
            </div>
            <div class="mt-2">${bullets || `<div class="text-slate-600">‚Ä¢ Strong overall match.</div>`}</div>
          </div>
        `;
      }).join("");

      root.innerHTML = header + items;
    }

    function copyReasoningToClipboard() {
      const log = state.buildLog;
      if (!log) return;

      const lines = [];
      lines.push(`Your profile: ${log.profileLine}`);
      lines.push(log.narrative);
      lines.push("");
      lines.push("Top 5 (stack order):");
      log.items.forEach((it, i) => {
        lines.push(`${i+1}. ${it.name} ‚Äî ${it.role}`);
        (it.reasons || []).forEach(r => lines.push(`   - ${r}`));
      });

      const text = lines.join("\n");
      (navigator.clipboard && navigator.clipboard.writeText ? navigator.clipboard.writeText(text) : Promise.reject())
        .then(()=> openModal("Copied", `<div class="text-slate-700">Copied the explanation to your clipboard.</div>`))
        .catch(()=> openModal("Copy failed", `<div class="text-slate-700">Couldn‚Äôt copy automatically. Select and copy from the panel.</div>`));
    }



    // --- Diagnostics panel: inputs ‚Üí outputs JSON ---
    function buildDiagnosticsPayload() {
      const inputs = {
        year: state.year || "",
        major: state.majorDisplay || "",
        interests: Array.from(state.interests || []),
        themes: Array.from(state.themes || []),
        toggles: {
          preferActive: !!state.preferActive,
          showWhy: !!state.showWhy,
          debugScores: !!state.debugScores,
          showReasoning: !!state.showReasoning
        },
        search: state.search || "",
        sort: state.sort || "best",
        refine: {
          faith: { open: !!state.faithOpen, selected: Array.from(state.faithSelected || []) },
          identity: { open: !!state.identityOpen, selected: Array.from(state.identitySelected || []) },
          discipline: { open: !!state.disciplineOpen, selected: Array.from(state.disciplineSelected || []) }
        }
      };

      const rec = (state.recommended || []).map((it, idx) => ({
        index: idx + 1,
        name: (it.entry?.name || "Untitled").toString(),
        theme: (it.entry?.theme || "").toString(),
        school: (it.entry?.school || "").toString(),
        score: (typeof it.score === "number" ? it.score : null),
        roundedScore: (typeof it.score === "number" ? Math.round(it.score) : null),
        role: (state.buildLog?.items?.[idx]?.role) || computeRoleForSlot(it, idx),
        reasons: whyForItem(it, idx),
        scoreBreakdown: it.dbg || null,
        domain: (it.entry?.domain || "").toString(),
        majorsTagged: (it.entry?.associated_majors || "").toString()
      }));

      return {
        ts: new Date().toISOString(),
        inputs,
        output: {
          matchesCount: (state.scored || []).length,
          recommended: rec,
          explanation: state.buildLog || null
        }
      };
    }

    function renderDiagnostics() {
      const pre = $("diagJson");
      if (!pre) return;
      const payload = buildDiagnosticsPayload();
      const txt = JSON.stringify(payload, null, 2);
      pre.textContent = txt;
      state.lastDiagJson = txt;
    }

    function copyDiagnosticsToClipboard() {
      const txt = state.lastDiagJson || ($("diagJson")?.textContent || "");
      if (!txt) {
        openModal("Nothing to copy", `<div class="text-slate-700">Run <span class="font-medium">Get recommendations</span> first.</div>`);
        return;
      }



      (navigator.clipboard && navigator.clipboard.writeText ? navigator.clipboard.writeText(txt) : Promise.reject())
        .then(()=> openModal("Copied", `<div class="text-slate-700">Copied diagnostics JSON to your clipboard.</div>`))
        .catch(()=> openModal("Copy failed", `<div class="text-slate-700">Couldn‚Äôt copy automatically. Select and copy from the diagnostics panel.</div>`));
    }


    function renderResults() {
      const root = $("recommended");
      root.innerHTML = "";
      const rec = state.recommended || [];
      rec.forEach(item => root.insertAdjacentHTML("beforeend", renderCard(item)));
      attachCardHandlers();
      renderReasoning();
            renderDiagnostics();
$("matchCount").textContent = `${(state.scored || []).length} matches`;
      $("emptyState").classList.toggle("hidden", rec.length !== 0);
    }

    function clearResults() {
      state.scored = [];
      state.recommended = [];
      $("recommended").innerHTML = "";
      $("matchCount").textContent = "0 matches";
      renderDiagnostics();
      $("emptyState").classList.add("hidden");
    }

    function updateProfilePill() {
      const parts = [];
      if (state.year) parts.push(state.year);
      if (state.majorDisplay) parts.push(state.majorDisplay.toLowerCase());
      if (state.interests.size) parts.push(Array.from(state.interests).slice(0,2).join(" ‚Ä¢ "));
      $("profilePill").textContent = parts.length ? parts.join(" ‚Ä¢ ") : "‚Äî";
    }

    function rerun() {
      const data = state.data || [];
      const out = [];
      for (const entry of data) {
        const item = computeScore(entry);
        if (!item) continue;
        out.push(item);
      }
      state.scored = out;
      buildRecommended();
      renderResults();
    }

    $("search").addEventListener("input", (e) => {
      state.search = e.target.value;
      buildRecommended();
      renderResults();
    });

    $("sort").addEventListener("change", (e) => {
      state.sort = e.target.value;
      buildRecommended();
      renderResults();
    });

    $("btnResetResults").addEventListener("click", () => {
      $("search").value = "";
      $("sort").value = "best";
      state.search = "";
      state.sort = "best";
      buildRecommended();
      renderResults();
    });

    $("btnCopyReasoning").addEventListener("click", copyReasoningToClipboard);


    
    
    // Download diagnostics JSON as a .txt file (global scope)
    function downloadDiagnosticsAsTxt() {
      const txt = state.lastDiagJson || ($("diagJson")?.textContent || "");
      if (!txt) {
        openModal("Nothing to download", `<div class="text-slate-700">Run <span class="font-medium">Get recommendations</span> first.</div>`);
        return;
      }
      const blob = new Blob([txt], { type: "text/plain;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      const stamp = new Date().toISOString().replace(/[:.]/g, "-");
      a.href = url;
      a.download = `club-recs-diagnostics-${stamp}.txt`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(url), 500);
    }

    $("btnCopyDiag").addEventListener("click", copyDiagnosticsToClipboard);

    $("btnDownloadDiagTxt").addEventListener("click", downloadDiagnosticsAsTxt);
$("btnGet").addEventListener("click", async () => {
      if (state.interests.size === 0) {
        openModal("Pick an interest", "<div>Please select at least one interest to get recommendations.</div>");
        return;
      }
      state.year = $("yearSelect").value || state.year;
      state.majorDisplay = $("majorInput").value.trim();
      state.majorKey = state.majorDisplay.toLowerCase();
      try {
        await loadData(false);
        if (state.wantsFaith || state.wantsIdentity) await buildRefineOptions();
        if (state.wantsAcademic) await buildAcademicRefineOptions();
        updateProfilePill();
        rerun();
      } catch (e) {
        openModal("Couldn‚Äôt load data", `<div class="text-red-700">${escapeHtml(e.message || String(e))}</div>`);
      }
    });

    $("btnSurprise").addEventListener("click", () => {
      const years = ["Freshman","Sophomore","Junior","Senior"];
      const year = years[Math.floor(Math.random()*years.length)];
      $("yearSelect").value = year;
      state.year = year;
      const m = normalizeMajorLabel(MAJORS[Math.floor(Math.random()*MAJORS.length)] || "Accounting");
      setMajor(m);

      state.interests.clear();
      state.themes.clear();
      const pool = INTERESTS.filter(i => !["Faith & Spirituality","Cultural & Identity"].includes(i.ux));
      while (state.interests.size < 2 && pool.length) {
        const pick = pool[Math.floor(Math.random()*pool.length)];
        state.interests.add(pick.ux);
        state.themes.add(pick.theme);
      }
      state.wantsFaith = false;
      state.wantsIdentity = false;
      state.wantsAcademic = state.interests.has("Academic");
      // Reset refinements for surprise
      state.disciplineSelected.clear();
      state.disciplineOpen = false;
      maybeShowRefine();
      maybeShowAcademicRefine();
      renderInterestPills();
      updateProfilePill();
      clearResults();
    });

    (async function init() {
      renderInterestPills();
      updateProfilePill();
      renderDiagnostics();
      try { await loadData(false); } catch {}
      maybeShowRefine();
      maybeShowAcademicRefine();
    })();
  </script>
</body>
</html>
